---
title: "Untitled"
author: "kmm"
date: "4/1/2017"
output: html_document
---

## Heritability and genetic correlation

<center>
<img src="https://s-media-cache-ak0.pinimg.com/originals/b0/09/d6/b009d6cbadcf86f97609886a6e52cac7.jpg" width="65%" />
</center>


## Load pedigree

```{r}
library(MCMCglmm)
library(kinship2)

data(BTped)
head(BTped)
```
---

```{r}
Nped <- BTped[which(apply(BTped, 1, function(x) {
  any(x == "R187920" | x == "R187921")})), ]
Nped
```

## Plot part of pedigree

```{r warning=FALSE}
ped <- pedigree(id = Nped$animal,
                dadid = Nped$sire,
                momid = Nped$dam,
                sex = c(2, 1, rep(3, nrow(Nped) - 2)))
plot(ped)
```

## Genetic distance

```{r}
str(BTped)

Aped <- 2 * kinship2::kinship(Nped[, 1], Nped[, 2], Nped[, 3])
Aped
```

## Data

```{r}
data(BTdata)
head(BTdata)
```

## Heritability of tarsus length

```{r, eval = FALSE}
prior <- list(R = list(V = 0.002, n = 2),
              G = list(G1 = list(V = 0.002, n = 2)))

fm1 <- MCMCglmm(
  fixed = tarsus ~ 1,
  random = ~ animal,
  prior = prior,
  family = c("gaussian"),
  nitt = 60000, burnin = 10000, thin = 25,
  data = BTdata, pedigree = BTped,
  verbose = FALSE)
save(fm1, file = "../data/BT_herit.Rda")
```

```{r echo=FALSE}
load("../data/BT_herit.Rda")
```

## Fixed effects

```{r}
plot(fm1$Sol)
```

## Random effects

```{r}
plot(fm1$VCV)
```

## Heritability

$$h^2 = \frac{V_a}{V_a + V_r}$$

```{r}
herit <- fm1$VCV[, "animal"] / (fm1$VCV[, "animal"] + fm1$VCV[, "units"])
plot(herit)
```

## Heritability

```{r}
median(herit)
HPDinterval(herit)
```

## Genetic correlation

```{r eval=FALSE}
prior <- list(R = list(V = diag(2) * 1.001, n = 2),
              G = list(G1 = list(V = diag(2)  * 1.001, n = 2)))

fm2 <- MCMCglmm(
  fixed = cbind(back, tarsus) ~ trait,
  random = ~ us(trait):animal,
  rcov = ~ us(trait):units,
  prior = prior,
  family = c("gaussian", "gaussian"),
  nitt = 60000, burnin = 10000, thin = 25,
  data = BTdata, pedigree = BTped,
  verbose = FALSE)
save(fm2, file = "../data/BT_genetic_correlation.Rda")
```

```{r echo=FALSE}
load("../data/BT_genetic_correlation.Rda")
```

## Genetic correlation

```{r}
Genet_Corr <- fm2$VCV[ , "traittarsus:traitback.animal"] /
  sqrt(fm2$VCV[ , "traittarsus:traittarsus.animal"] *
         fm2$VCV[ , "traitback:traitback.animal"])
plot(Genet_Corr)
```

## Genetic correlation

```{r}
median(Genet_Corr)
HPDinterval(Genet_Corr)
```

