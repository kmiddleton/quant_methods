---
title: "General(ized) Linear Models: Partitioning Variance"
subtitle: "Quantitative Methods in Life Sciences"
author: 'Elizabeth King, Kevin Middleton, and Lauren Sullivan'
output:
  ioslides_presentation:
    fig_width: 8
    css: styles.css
csl: evolution.csl
bibliography: Multivariate.bib
---

```{r setup, echo=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
library(cowplot)
theme_set(theme_cowplot())
library(readxl)
#library(GGally)
library(ggrepel)
#library(rgl)
library(knitr)
#knit_hooks$set(webgl = hook_webgl)
knitr::opts_chunk$set(cache = TRUE)
```

## GLMs and Variance 

> How much of the variation in the outcome variable is explained by the predictor variables?

<center>
<img src="https://i.imgur.com/E2Gu7ke.png" width="80%" />
</center>

## Multiple Regression Makes a Composite Variable

- Linear combination of predictor variables that is maximally correlated with outcome variable
- How well can you predict the outcome by the set of predictor variables?
    - correlation of y with $\hat{y}$ 
    - $R^{2}$ = squared correlation coefficient of y with $\hat{y}$ 
    
## Milk Energy

```{r}
milk <- read_excel("../data/Milk.xlsx", na = "NA")
M <- milk %>%
  select(species, kcal.per.g, mass, neocortex.perc) %>%
  drop_na()
names(M) <- c("Species", "Milk_Energy", "Mass", "Neocortex")
M <- M %>% mutate(log_Mass = log(Mass))
```

## Visualizing data

```{r webgl=TRUE, echo=FALSE}
#plot3d(M$log_Mass, M$Neocortex, M$Milk_Energy,
#       type = "s", col = "red", size = 1,
#       xlab = "log Body Mass",
#       ylab = "Percent Neocortex",
#       zlab = "Milk Energy")
```

## Multivariate model {.smaller}

```{r}
fm_Multi <- lm(Milk_Energy ~ Neocortex + log_Mass, data = M)
summary(fm_Multi)
```

## $R^{2}$: Multiple Regression Makes a Composite Variable

```{r echo=FALSE}
y_hat <- fm_Multi$fitted.values

ggplot(M, aes(x = y_hat, y = Milk_Energy)) +
  geom_point() +
  geom_smooth(method = 'lm', se = FALSE) +
  ylab('Milk Energy') +
  xlab('Predicted Milk Energy') 
```

## $R^{2}$: Multiple Regression Makes a Composite Variable

```{r}
cor(y_hat, M$Milk_Energy)^2
summary(fm_Multi)$r.squared
```


## "Analysis of Variance"

Some total variability in *Y*:

1. Part explained by group membership
1. Part remains unexplained ("error" or "residual")

$F$-statistic is the ratio of the two.

## Visualizing ANOVA

<center>
<img src="https://i.imgur.com/dNF4ph0.png" width="100%" />
</center>

$$F = \frac{\mbox{Between Group Variation}}{\mbox{Within Group Variation}}$$

## Parts of an ANOVA table

```{r message=FALSE, echo=FALSE}
JL <- read_csv("../data/JetLag.csv") %>% 
  mutate(Treatment = factor(Treatment))
fm_lm <- lm(Shift ~ Treatment, data = JL)
```

```{r echo=FALSE}
anova(fm_lm)
```

- `Sum Sq`: Variability accounted for by that part of the ANOVA
- `Mean Sq`: `Sum Sq` / `Df`
- `F value`: `Mean Sq` Treatment / `Mean Sq` Residual
- `Pr(>F)`: *P*-value for the *F*-test of that variable


## How much variation is explained by group membership: $R^{2}$?

```{r echo=FALSE}
anova(fm_lm)
```

- `Sum Sq`: Variability accounted for by that part of the ANOVA
- `Mean Sq`: `Sum Sq` / `Df`
- `F value`: `Mean Sq` Treatment / `Mean Sq` Residual
- `Pr(>F)`: *P*-value for the *F*-test of that variable

## How much variation is explained by group membership: $R^{2}$?

$$R^{2} = \frac{\mbox{Variation accounted for by group membership}}{\mbox{Total variation}}$$
$$R^{2} = \frac{\mbox{Sum Sq Group}}{\mbox{(Sum Sq Group + Sum Sq Residuals)}}$$

## How much variation is explained by group membership: $R^{2}$?{.smaller}

```{r echo=FALSE}
anova(fm_lm)
```

```{r}
anova(fm_lm)$`Sum Sq`[1]/sum(anova(fm_lm)$`Sum Sq`)

7.224492/(7.224492 + 9.415345)
```

## How much variation is explained by group membership: $R^{2}$?{.smaller}

```{r echo=FALSE}
summary(fm_lm)
```
