---
title: "In class discussion"
subtitle: "Quantitative Methods in Life Sciences"
author: 'Elizabeth King and Kevin Middleton'
output:
  ioslides_presentation:
    fig_width: 8
    css: styles.css
csl: evolution.csl
bibliography: Multivariate.bib
---

```{r setup, echo=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
library(cowplot)
library(readxl)
library(lme4)
```


## Stream temperature data

```{r}
Temp_Data <- read_excel("../data/Streams.xlsx", sheet = "TemperatureData")
Site_Data <- read_excel("../data/Streams.xlsx", sheet = "SiteData")
M <- left_join(Temp_Data, Site_Data, by = "Site") %>% 
  mutate(Site = factor(Site),
         Date = factor(Date),
         Stream_Name = factor(Stream_Name),
         Day = as.numeric(Date))
```


## Nesting as an interaction

```{r}
fm1 <- lmer(WaterTemp ~ AirTempPredicted + Day +
              (1 | Stream_Name/Site),
           data = M, REML = FALSE)

fm2 <- lmer(WaterTemp ~ AirTempPredicted + Day +
              (1 | Stream_Name) +
              (1 | Stream_Name:Site),
           data = M, REML = FALSE)
```


## Nesting as an interaction

```{r}
fm1
fm2
```



## Independence

- What are independent observations?

## Familywise Error Rate

$$\mbox{FWER} = 1-(1-\alpha)^k$$

- For some arbitrary $\alpha$ and $k$ number of tests.
    - Within a single analysis
    - Multiple analyses within a study
- As soon as you do a few tests, the familywise error rate rises much above the nominal $\alpha$-level.

## Distribution of *P* values 

- What should the distribution of P-values look like if there is no signal?
- How would you figure this out empirically?

## Distribution of *P* values 

```{r cache=TRUE}
set.seed(3210)

nn <- 10
group1.mean <- 6
group2.mean <- 6

niter <- 100000
ps <- numeric(length = niter)

for(ii in 1:niter) {
  y <- c(rnorm(nn, group1.mean, 1), rnorm(nn, group2.mean, 1))
  gg <- rep(c('a','b'), each = nn)
  ps[ii] <- t.test(y ~ gg, var.equal = TRUE)$p.value
}
```

## Distribution of *P* values 

```{r echo=FALSE}
ggplot(tibble(ps), aes(x = ps)) +
  geom_histogram(bins = 100) +
  labs(x = "P value")
```

## Observed vs. Expected *P* values 

```{r}
log_10_p <- sort(-log10(ps))

unif <- runif(niter, 0, 1)
log_10_unif <- sort(-log10(unif))
```

## Uniform(0, 1) Distribution

```{r echo=FALSE}
p1 <- tibble(unif) %>% 
  ggplot(aes(unif)) +
  geom_histogram(bins = 100)

p2 <- tibble(log_10_unif) %>% 
  ggplot(aes(log_10_unif)) +
  geom_histogram(bins = 100)

plot_grid(p1, p2, nrow = 2)
```

## Distribution of -log10 P-Values

```{r echo=FALSE}
p3 <- tibble(log_10_p) %>% 
  ggplot(aes(log_10_p)) +
  geom_histogram(bins = 100)

plot_grid(p2, p3, nrow = 2)
```

## Observed vs. Expected *P* values 

```{r echo=FALSE, warning=FALSE, message=FALSE}
tibble(log_10_p, log_10_unif) %>% 
  ggplot(aes(x = log_10_unif, y = log_10_p)) + 
  geom_point() +
  geom_abline(intercept = 0, slope = 1) +
  xlim(c(0, 5)) +
  ylab("Observed -log10 P values") +
  xlab("Expected -log10 P values")
```
