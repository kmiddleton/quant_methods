---
title: 'Problem Set 09'
author: "Your Name Here: Group X"
date: 'Last updated: `r Sys.Date()`'
output:
  html_document:
    smart: no
    theme: flatly
    toc: true
    toc_float: true
---

```{r setup, message=FALSE, warning=FALSE}
# FIXME
library(tidyverse)
library(readxl)
library(cowplot)
library(forcats)
library(car)
library(nlme)
library(GGally)
library(epiDisplay)

library(knitr)
```


## Calcium concentration in bird plasma

The file `Bird_Plasma.xlsx` contains factorial data on blood plasma calcium concentration (`Calcium`, mg / 100 mL) in male and female birds (`Sex`) each of which was treated or not with a hormone (`Treatment`).


### Activity

Load the Excel file, and convert hormone and sex to factors. The levels of `Treatment` are "Hormone" and "None". Because "Hormone" is first alphabetically, it becomes the base level of the factor. Use `fct_relevel` from the `forcats` package to make "None" the base level.

```{r, message = FALSE}
# FIXME
M <- read_excel("../data/Bird_Plasma.xlsx") %>%
  mutate(Treatment = factor(Treatment),
         Sex = factor(Sex),
         Treatment = fct_relevel(Treatment, "None"))
```

Use `group_by()` and `tally()` to determine the sample size in each of the groups.

```{r}
# FIXME
M %>% group_by(Treatment, Sex) %>% tally()
```

Create interaction plots of the calcium concentration data. Use the code from lecture as a template. Make two plots, one with `Treatment` on the x axis and one with `Sex` on the x axis. Use `plot_grid()` to place them side by side

```{r}
# FIXME
p1  <- ggplot(M, aes(x = Sex,
              y = Calcium,
              color = Treatment,
              group = Treatment)) +
  geom_point(position = position_jitter(width = 0.1)) +
  stat_summary(fun.y = mean, geom = "point", pch = 12, size = 5) +
  stat_summary(fun.y = mean, geom = "line")

p2 <- ggplot(M, aes(x = Treatment,
              y = Calcium,
              color = Sex,
              group = Sex)) +
  geom_point(position = position_jitter(width = 0.1)) +
  stat_summary(fun.y = mean, geom = "point", pch = 12, size = 5) +
  stat_summary(fun.y = mean, geom = "line")
plot_grid(p1, p2, ncol = 2)
```

What do you learn from these plots?

> Hormone almost certainly has a strong positive effect -- the lines are very far apart in the first plot. Sexes appear not to differ that much, because the elevations of the lines in the second plot are very similar. Both sexes appear to response in the same direction with the same magnitude.

Fit a factorial linear model (both main effects and the interaction term) and save the result to an R object.

```{r}
# FIXME
fm <- lm(Calcium ~ Sex * Treatment, data = M)
```

Using the `Anova()` function in the `car` package, calculate an ANOVA table with type III sums of squares. You might have to install `car` first.

```{r}
# FIXME
Anova(fm, type = "III")
```

Describe the results of the analysis.

> To determine the relative roles of sex and hormone treatment on blood plasma calcium concentration, we used a 2 X 2 factorial design (*n* = 5 in each group). Factorial ANOVA with the interaction between sex and hormone treatment was analyzed using type III sums of squares. We found a significant effect of hormone treatmen (*F*~1,16~ = 41; *P* < 0.001). Sexes did not differ after controlling for other effects (*P* = 0.33), including the interaction (*P* = 0.62).

## Effect of predation on zooplankton

The file `Zooplankton.csv` contains data on the concentration of zooplankton in three predator treatment groups (control, low, and high). Each of the three treatments were measured in five replicate blocks.

### Activity

Read in the data and convert both Treatment and Block into factors. It is especially important to make sure that Block is a factor, because Blocks are coded 1-5. We need to make sure that R converts them to a model matrix (0's and 1's).

```{r, message = FALSE}
# FIXME
M <- read_csv("../data/Zooplankton.csv") %>%
  mutate(Treatment = factor(Treatment),
         Block = factor(Block))
```

Make two plots, one in which Treatment is on the x axis and Block is encoded by color, and the second in which Block is on the x axis and Treatment is encoded by color. Notice how you learn different things about the data from each of these plots.

```{r}
# FIXME
M %>%
  ggplot(aes(x = Treatment, y = Zooplankton, color = Block)) +
  geom_point()
M %>%
  ggplot(aes(x = Block, y = Zooplankton, color = Treatment)) +
  geom_point()
```

We want to test for significant differences in Treatment while accounting for the replicated blocks. We can fit this model in two different ways:

1. `lm()` and `anova()` with an additive model including Treatment and Block
2. `lme()` from the `nlme` package with Block as a random effect

Fit both of these models

```{r}
fm_lm <- lm(Zooplankton ~ Treatment + Block, M)
anova(fm_lm)

fm_lme <- lme(Zooplankton ~ Treatment,
              random = ~ 1 | Block, M)
anova(fm_lme)
```

Compare the output of the two models.

> The models are identical. There is a significant effect of Treatment (at least one mean is different), but there doesn't appear to be much difference between blocks.


## Testing a new drug

We will use data on the effects of a drug on fever, blood pressure, and pain. There are two treatments here: the drug, and a placebo as a control. We want to ask if the drug affects fever, blood pressure, or pain and conversely whether we can predict drug treatment from the change in symptoms.

### Activity

First read in the data (`Drug_test.xlsx`) and make `Treatment` a factor. You will need to make "Placebo" as the base level of the factor.

```{r}
M <- read_excel("../data/Drug_test.xlsx") %>%
  mutate(Treatment = factor(Treatment),
         Treatment = fct_relevel(Treatment, "Placebo"))
str(M)
```

Use `ggscatmat()` to visualize the relationships between our predictors: `Fever`, `BP`, and `Pain`. Color your points by treatment.

```{r}
ggscatmat(M, 1:3, color = "Treatment")
```

Are there any concerning patterns in the data?

> No, looks fine.

Fit a generalized linear model using `glm()`, predicting `Treatment` from `Fever`, `BP`, and `Pain`. Specify `family` as binomial to perform a logistic regression.

Use 1) `summary()`, 2) `logisitic.display()` from the `epiDisplay` package, and 3) `Anova()`, specifying type III sums of squares to look at the results. What can you conclude?

> Only fever is a good predictor of whether a person received the drug vs. placebo. The adjusted odds ratio of 0.23 (0.09 - 0.63) suggests that those with lower levels of fever were more likely to have received the drug. You can observe this in the scatterplot matrix in the upper left panel.

```{r}
# FIXME
fm <- glm(Treatment ~ Fever + BP + Pain, data = M,
          family = "binomial")

summary(fm)
logistic.display(fm)
Anova(fm, type = "III")
```

