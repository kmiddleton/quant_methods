---
title: "Repeatability"
author: 'Libby King'
date: 'Last updated: `r Sys.Date()`'
output:
  ioslides_presentation:
    fig_width: 7
    css: styles.css
csl: evolution.csl
bibliography: Multivariate.bib
---

```{r setup, echo=FALSE, message=FALSE}
library(knitr)
knitr::opts_chunk$set(cache = TRUE)
library(readxl)
library(ggplot2)
library(cowplot)
library(tidyverse)
```

## Intraclass correlation coefficient

The model you use to calculate the intraclass correlation coefficient is a multilevel model. You have repeated measurements for a single specimen. Those measurements are obviously not independent from one another. The major question you want to ask is: What is the relative among measurement vs. between specimen variation? We will fit this model in two ways: using `anova(lm())` and using `lme()`. STATE DIFFERENCE HERE.

First, plot the two measurements for head height (HeadHt) in the G44_Morphometrics.xlsx dataset against one another. 

```{r echo=FALSE}
M <- read_excel("../data/G44_Morphometrics.xlsx")
ggplot(M, aes(HeadHt1, HeadHt2)) +
  geom_abline(slope = 1, intercept = 0) +
  geom_point() +
  xlab("Head Height #1 (mm)") +
  ylab("Head Height #2 (mm)")
```

Based on your plot, do you expect repeatability to be high or low?

>

COULD DO MORE THAN ONE PLOT

Now, follow the example from lecture to calculate repeatability of the head height (HeadHt) measurement using `anova(lm())`.

```{r}
Heads <- data.frame(HeadHt = c(M$HeadHt1, M$HeadHt2),
                      MouseID = factor(c(M$MouseID, M$MouseID)))
Heads <- Heads %>% drop_na()
fm <- aov(HeadHt ~ MouseID, data = Heads)
print(S <- summary(fm), digits = 5)
var_a <- (S[[1]]$'Mean Sq'[1] - S[[1]]$'Mean Sq'[2]) / 2
var_a / (var_a + S[[1]]$'Mean Sq'[2])
```

Now, calculate repeatability of the head height (HeadHt) measurement using `lme()` with MouseID treated as a random effect. 

1) Fit a linear model using `lme()` with MouseID treated as a random effect.

```{r}
library(nlme)
fm_lme <- lme(HeadHt ~ 1,
              random = ~ 1 | MouseID,
              data = Heads,
              method = "ML")
```


2) Extract the coefficients of your model. Compare these with the means for each MouseID. Hint: `group_by()` and `summarize()` will help here. What is the relationship between the intercept estimates and the means calculated for each MouseID??
 
>

```{r}
head(coef(fm_lme))

MouseMeans <- Heads %>% group_by(MouseID) %>% summarize(mean(HeadHt)) 
```

3) Use `VarCorr()` to calculate the variace components for your model object. The first column of the output hold the two estimated variance components. No need to do further calculations. These are true variances, not mean squares. Use these to calculate repeatability. Also, use `var()` to get the variance of the means per MouseID you calculated in #2. What is the relationship between the variance of the means per MouseID and the variances from `VarCorr()`?

>

```{r}
(varcomps <- VarCorr(fm_lme))
var.among <- as.numeric(varcomps[1, 1])
var.within <- as.numeric(varcomps[2, 1])
var.among / (var.among + var.within)

print(var(MouseMeans[,2]),digits=4)
print(var.among, digits=4)

MouseVars <- Heads %>% group_by(MouseID) %>% summarize(var(HeadHt)) 
MouseVars<-as.data.frame(MouseVars)

print(mean(as.numeric(MouseVars[,2])),digits=4)
print(var.within, digits=4)

```

